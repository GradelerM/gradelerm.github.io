---
title: "Serveurs Carto et OpenLayers - le point technique"
author: "Marie Gradeler"
date: 27 Nov 2024
format: 
  revealjs: 
    theme: [default, ../../styles/slides.scss]
    transition: slide
    controls: true
    controls-layout: edges
    footer: "Formation WebCarto GeoNum 2024 -2025"
    logo: ../../static/logos/logo-geonum.webp
---

## Sommaire

-   Pr√©sentation br√®ve d‚ÄôOpenLayers

-   Les bases de Node JS

-   De quelle architecture on a besoin¬†?

-   VMs, Docker et Docker Compose

-   Notre Docker Compose

Et si on avance bien, aujourd‚Äôhui on aura non pas **UN** mais **DEUX** cours¬†! Alors ne perdons pas de temps et en avant¬†!

![](https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExMnpieGN1MXJ4NzZvZ3Vzd2R5ODN6cGtvOGk5MTNqaG91MGd5aXlhMyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/Uow8AG1hMg1qxfWrzQ/giphy.webp){fig-alt="GIF : Rick et Morty d√©sespoir" fig-align="center"}

## Pr√©sentation br√®ve d‚ÄôOpenLayers

-   [OpenLayers](https://openlayers.org/) est une librairie JavaScript Open Source qui permet de cr√©er des cartes interactives pour le web.

-   La librairie a plus de 11¬†000 stars sur GitHub et 3¬†000 forks.

-   Au moment o√π j‚Äô√©cris ce cours, la derni√®re mise √† jour date d‚Äôil y a deux jours.

-   L‚Äôalpha d‚ÄôOpenLayers (premi√®re version mise en ligne sur GitHub) date de 2013.

**C‚Äôest une librairie populaire, mature, maintenue et bien document√©e.**

![](media/openlayers_site.png){fig-alt="GIF : Site de OpenLayers" fig-align="center" width="620"}

## Pr√©sentation br√®ve d‚ÄôOpenLayers

ü§î √áa ressemble en tout point √† [Leaflet](https://leafletjs.com/), non¬†? Alors pourquoi apprendre les deux¬†?

. . .

üëâ Oui et non¬†!

-   **Leaflet** est plus pratique pour obtenir rapidement une "jolie" carte avec moins de code, par exemple afficher/masquer les couches.

-   Mais Leaflet a aussi ses d√©fauts¬†: la carte est plus difficile √† customiser "en profondeur" qu‚ÄôOpenLayers, il y a de nombreux plug-ins qui parfois font plus ou moins la m√™me chose, parfois ne sont plus maintenus, l√† o√π beaucoup de ces fonctionnalit√©s sont disponibles dans le code de base d‚ÄôOpenLayers.

. . .

**Pour faire simple**, selon mon exp√©rience avec les deux librairies, **OpenLayers est plus facilement customisable et se repose moins sur des plug-ins externes.** Il existe une source de plug-ins pour ajouter des fonctionnalit√©s suppl√©mentaires publi√©e par l‚Äôutilisateur GitHub [viglino](https://github.com/Viglino). Ces extensions [ol-ext](https://viglino.github.io/ol-ext/) sont r√©guli√®rement maintenues.

## Pr√©sentation br√®ve d‚ÄôOpenLayers

Il est donc int√©ressant de savoir utiliser √† la fois Leaflet et OpenLayers car chacune des librairies a ses points forts et ses faiblesses.

Cela dit, en ce qui concerne un usage simplifi√©, **si vous comprenez Leaflet vous comprenez aussi OpenLayers**.

![](media/la_webcarto_libre.jpg){fig-alt="GIF : Leaflet et OpenLayers, la webcarto libre" fig-align="center" width="356"}

On va devoir cr√©er une application Node JS pour pouvoir importer la librairie OpenLayers et commencer √† coder.

## Les bases de Node JS

Node JS, c‚Äôest ce qu‚Äôon appelle un environnement runtime de JavaScript.

Voil√†. On continue¬†?

![](https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcXNsN2xrc2kzM3dleGRhcXgya3o1dnAwdWlpb2FzbmNuMW5xa2pidCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3o84TZ6rOiGqdpzNRe/giphy.webp){fig-alt="GIF : Perceval dit \"j'ai rien compris\"" fig-align="center"}

## Les bases de Node JS

Pour simplifier, voyons comment vous √©crivez et ex√©cutez votre code JavaScript jusqu‚Äô√† maintenant.

-   On cr√©e un document `index.html` dans lequel on met quelque part une balise `<script>`

-   On √©crit le code dans la balise `<script>`

-   On ouvre `index.html` dans le navigateur

-   Comme le JavaScript est dans `index.html` qui est ouvert dans un navigateur, le navigateur peut ex√©cuter le code JavaScript

**Ce n‚Äôest pas super pratique quand on commence √† avoir une application qui grandit (ou "scale").**

## Les bases de Node JS

La force de Node JS est de permettre d‚Äôex√©cuter du code √©crit en JavaScript sans passer par le navigateur. Si par la suite vous devez √©crire du code c√¥t√© serveur, vous pouvez aussi le faire en JavaScript. Et surtout, Node JS permet de t√©l√©charger facilement des librairies et d√©ployer encore plus facilement notre application pour la **mettre en production** en utilisant quelques lignes de commande.

![](media/logo_node_js.png){fig-alt="Logo Node JS" fig-align="center" width="300"}

## Un serveur pour mon appli web

Vous vous souvenez s√ªrement du premier cours de Leaflet.

![](media/diapo_mickael_shocked.png){fig-alt="Diapo Leaflet \"on va tricher\"" fig-align="center" width="536"}

## Un serveur pour mon appli web

Vous avez "trich√©" pour √©viter d‚Äôavoir √† utiliser un serveur. Mais maintenant, √ßa ne vous fait plus peur. Apr√®s tout, on a bien utilis√© un serveur carto la derni√®re fois et tout le monde a surv√©cu. Maintenant, on va pouvoir √©crire une application web plus complexe, bien la structurer gr√¢ce √† Node JS, et la servir sur un **serveur web**.

![](media/diapo_mickael_server.png){fig-alt="Diapo Leaflet sur l‚Äôarchitecture serveur" fig-align="center" width="1250"}

## De quelle architecture on a besoin¬†?

Facile¬†! On veut¬†:

-   un **serveur webcarto** (GeoServer)

-   mais aussi un **serveur web** pour servir notre application.

Durant le premier TP, on a utilis√© Docker pour d√©ployer notre GeoServer. On peut aussi d√©ployer notre serveur web avec Docker. Mais √ßa voudrait dire qu‚Äô√† chaque fois, on aurait deux containers diff√©rents √† allumer et √©teindre, qu‚Äôil faut faire attention √† ne pas les configurer de travers, ne pas oublier les lignes de commande qu‚Äôon a tap√©es‚Ä¶

![](media/logo-docker.jpg){fig-alt="Logo docker" fig-align="center" width="356"}

Heureusement, Docker dispose d‚Äôun petit outil bien pratique pour g√©rer des architectures √† plusieurs containers¬†: **Docker Compose**. Sauf que pour comprendre Docker Compose, il faut comprendre Docker. Et pour comprendre Docker, il faut comprendre les Machines Virtuelles (VM).

## VMs, Docker et Docker Compose

Encore de la th√©orie¬†?!

![](https://media1.tenor.com/m/N47hDzQgp5QAAAAd/jdg-bored.gif){fig-alt="Joueur du Grenier blas√©" fig-align="center"}

On ne va pas rentrer dans le d√©tail, l‚Äôid√©e est que vous compreniez pourquoi on a utilis√© Docker et pas des machines virtuelles pour nos serveurs. Docker, c‚Äôest bien. Si vous d√©ployez des architectures par la suite, vous allez apprendre √† l‚Äôaimer.

## VMs, Docker et Docker Compose

### Les Machines Virtuelles (VM)

-   Il faut voir une machine virtuelle comme un ordinateur qui serait **d√©mat√©rialis√©** (sans composants mat√©riels). Elle poss√®de un processeur, de la m√©moire, des espaces de stockage pour la donn√©e, elle peut se connecter √† internet‚Ä¶

-   Outils de cr√©ation de machines virtuelles¬†: VirtualBox, VMWare‚Ä¶

*Exemple¬†: en t√©l√©chargeant VirtualBox, je peux cr√©er une machine virtuelle Linux sur mon ordinateur Windows.*

![Source : microsoft.com](media/virtual-machine-diagram.svg){fig-alt="Diagramme Machine Virtuelle" fig-align="center"}

## VMs, Docker et Docker Compose

### Les Machines Virtuelles (VM)

Si je voulais mettre en place mon serveur sur une machine virtuelle, je devrais¬†:

-   cr√©er la machine (avec des caract√©ristiques suffisantes pour faire tourner l‚Äôapplication)

-   installer et configurer mon serveur web (Apache, Nginx, Caddy)

-   ajouter le build de mon application Node JS dans le dossier `/var/www/` de mon serveur web

-   t√©l√©charger, installer et configurer GeoServer

-   √©ventuellement t√©l√©charger, installer et configurer une base Postgresql avec PostGIS et la connecter au serveur

-   etc.

![](https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExYm1qNGw0eHk1ZmxmNmtiaXQwenc5NDdqcDRkbTNyc3M1YmJzdXRnbCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/LgR0AnXJBrO4E/giphy.webp){fig-alt="GIF : Chat d√©boussol√©" fig-align="center" width="412"}

## VMs, Docker et Docker Compose

### Les Machines Virtuelles (VM)

Multiplier les machines virtuelles sur l‚Äôh√¥te est tr√®s demandeur.

-   ressources divis√©es entre l‚Äôh√¥te et les machines

-   autant d‚ÄôOS √† faire tourner que de machines

-   chaque machine = plusieurs Go d‚Äôespace

C‚Äôest aussi **difficile √† maintenir** - il faut garder tous les OS √† jour, etc.

**Mais nous, on aime la simplicit√© et √©viter de consommer plein de m√©moire "pour rien".**

## VMs, Docker et Docker Compose

### Docker

-   Docker permet de faire tourner ce qu‚Äôon appelle des **containers.**

-   Les containers sont r√©duits au **minimum n√©cessaire** pour faire tourner des services (un serveur, une base de donn√©es, ‚Ä¶).

-   Autre outil de containerisation¬†: Podman

![Source : microsoft.com](media/container-diagram.svg){fig-alt="Sch√©ma containers" fig-align="center"}

## VMs, Docker et Docker Compose

### Docker Compose

-   Sorti en 2013, **Docker Compose** permet de g√©rer des applications multi-containers.

-   Pour cela, on va r√©diger un fichier de type `docker-compose.yml` qui va agir comme une "recette" pour permettre √† Docker de cr√©er et connecter l‚Äôensemble des containers dont on a besoin.

------------------------------------------------------------------------

Courage, on touche √† la fin de ce cours. On fait juste ensemble un tour du `docker-compose.yml` du TP et vous allez pouvoir commencer √† manipuler.

![](https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExbnBiZHgwZ2t3M281cnFnYWtoZXBmdGxzMW1sM2J6MnFkemdseHRmNiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/fXzA0KYfjTPjWLzmPj/giphy.webp){fig-alt="GIF : Rick et Morty paniquent, la suite" fig-align="center" width="320"}

## Notre Docker Compose

Explications sur le contenu¬†:

``` {.yaml code-line-numbers="|1|3,15|3|4|5|6,7,8,9|10,11|12,13|15|16|17|18,19|20,21,22"}
services:

  geoserver:
    container_name: geonum_geoserver
    image: docker.osgeo.org/geoserver:2.26.0
    environment:
      - RUN_UNPRIVILEGED=true
      - CHANGE_OWNERSHIP_ON_FOLDERS="/opt /opt/geoserver_data/ /mnt/geoserver_geodata"
      - CORS_ENABLED=true
    ports:
      - "8080:8080"
    volumes:
      - $PWD/geoserver/opt:/opt/geoserver_data
  
  web:
    container_name: geonum_web
    image: caddy:latest
    ports:
      - "80:80"
    volumes:
      - $PWD/Caddyfile:/etc/caddy/Caddyfile
      - $PWD/app/dist/:/srv
```

## √Ä vous !

Commencez le TP "d√©marrage de la stack" pour mettre en place vos containers¬†! Ensuite, on pourra se pencher un peu plus sur le cas d‚ÄôOpenLayers.
