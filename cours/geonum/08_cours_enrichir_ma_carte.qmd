---
title: "Enrichir ma carte"
format: html
---

## Objectifs de la session

Cette fois, câ€™est nous qui dÃ©finissions les objectifs petit Ã  petit en fonction de nos besoins.

## Supports

Aujourdâ€™hui, câ€™est de la pratique. Mâ€™entendre parler pendant des heures, câ€™est finiÂ !

![](https://kaamelott-gifboard.fr/gifs/on-en-a-gros.gif){fig-alt="GIF : Kaamelott on en a gros" fig-align="center" width="427"}

## TP â€“ Ajouter une table attributaire personnalisÃ©e

::: callout-important
## Pour bien dÃ©marrer le TPâ€¦

Ce TP part du principe que vous avez suivi les prÃ©cÃ©dents. Si ce nâ€™est pas le cas, il manquera des Ã©lÃ©ments importants dans votre code. **Les exercices suivants partent du principe que vous avez dÃ©jÃ  affichÃ© vos couches, il faudrait donc au moins que celles-ci soient fonctionnelles pour la suiteÂ !**
:::

On va se rÃ©intÃ©resser Ã  notre couche WMS "deals" et Ã  sa table attributaire (session "Interactions carte-interface). Je vous remets notre code ici pour vous rappeler quels Ã©lÃ©ments permettent de rÃ©cupÃ©rer la table attributaire. Attention au nom de vos couches et de vos sources, ce ne sont peut-Ãªtre pas les mÃªmes que les miensÂ !

``` javascript
map.on('singleclick', (event) => {
  const coord = event.coordinate;
  const res = map.getView().getResolution();
  const proj = 'EPSG:3857';
  const parametres = {'INFO_FORMAT': 'text/html'};

  const url = sourceDeals.getFeatureInfoUrl(coord, res, proj, parametres);

  if (url) {
    fetch(url)
      .then((response) => response.text())
      .then((html) => {
        document.getElementById('attributes').innerHTML = html;
       });
  }
});
```

Faites attention Ã  cet Ã©lÃ©mentÂ :

``` javascript
const parametres = {'INFO_FORMAT': 'text/html'};
```

Notez quâ€™on demande en fait Ã  notre GeoServer de nous donner la **rÃ©ponse** de notre **requÃªte** au format **text/html**. Câ€™est sympathique, mais difficile Ã  customiser et surtout pas super pratique quand la table attribuaire est LONGUE. Heureusement, on peut rÃ©cupÃ©rer le rÃ©sultat au format JSON qui sera bien pratique pour customiser notre table.

Comme toujours, quand on souhaite ajouter un nouvel Ã©lÃ©ment Ã  notre carte, il faut quâ€™on commence par Ã©crire du HTML. On va modifier notre div `id="attributes"` pour y ajouter une table. RÃ©cupÃ©rez le code ci-dessous et regardez la diffÃ©rence, vous allez comprendre.

``` javascript
<div id="attributes" class="menu">
    <!-- Je crÃ©e une table -->
    <table>
<!-- On utilise lâ€™Ã©lÃ©ment tr pour crÃ©er une ligne : tr = table row -->
    <tr>
        <!-- On utilise les Ã©lÃ©ments th (table header) pour crÃ©er les headers de nos trois colonnes -->
        <th>Deal ID</th>
        <th>Creation date</th>
        <th>Country</th>
    </tr>
    <!-- On utilise lâ€™Ã©lÃ©ment tr pour crÃ©er une AUTRE ligne : tr = table row -->
    <tr>
        <!-- On crÃ©e trois colonnes vides avec td -->
        <td>â€¦</td>
        <td>â€¦</td>
        <td>â€¦</td>
    </tr>
</table>
</div>
```

Vous devriez maintenant voir apparaÃ®tre une table dans votre `div`. Elle est austÃ¨re, dâ€™accord, mais vous pourrez la styliser aprÃ¨s. Pour le moment, on va faire avec. Regardez bien mes commentaires pour comprendre comment est structurÃ© le code ainsi que ces trois Ã©lÃ©mentsÂ :

``` html
      <td>â€¦</td>
      <td>â€¦</td>
      <td>â€¦</td>
```

Vous comprenez sÃ»rement quâ€™on souhaite remplacer ces "â€¦" par des valeurs lorsquâ€™on clique sur un point de la couche. Il va donc falloir modifier cet Ã©lÃ©ment HTML avec nos fonctions JavaScript. Souvenez-vous quâ€™on utilise les identifiants pour retrouver les Ã©lÃ©ments HTML avec `.getElementById()`. DoncÂ :

``` html
      <td id="table-deal-id">â€¦</td>
      <td id="table-creation-date">â€¦</td>
      <td id="table-country">â€¦</td>
```

Maintenant quâ€™on a nos Ã©lÃ©ments, il va falloir les remplir. Retournez chercher votre mÃ©thode `map.on()` dans votre code, on va devoir lâ€™amÃ©liorer un peu.

``` javascript
map.on('singleclick', (event) => {
  const coord = event.coordinate;
  const res = map.getView().getResolution();
  const proj = 'EPSG:3857';

  const parametres = { 'INFO_FORMAT': 'application/json' } // On a changÃ© un truc ici

  const url = sourceDeals.getFeatureInfoUrl(coord, res, proj, parametres);

  if (url) {
    fetch(url)
      .then((response) => response.text())
      .then((json) => { // On a aussi changÃ© un truc ici et dans la fonction
        const obj = JSON.parse(json);
        console.log(obj);
      });
  }
});
```

Testez votre couche et regardez le rÃ©sultat dans la console. Si tout a fonctionnÃ©, vous devriez voir un objet JavaScriptÂ ! Prenez le temps de lâ€™explorer dans votre console pour comprendre ce que vous regardez. Lâ€˜information qui nous intÃ©resse est quelque part dans `features`. VoilÃ  ce quâ€™on doit faire avec la donnÃ©eÂ :

-   vÃ©rifier quâ€™on a bien cliquÃ© sur une feature sur la carte (en JavaScript, Ã§a demande de vÃ©rifier quâ€™on a bien de la donnÃ©e dans `features`)

-   rÃ©cupÃ©rer la `feature` sur laquelle jâ€™ai cliquÃ© pour pouvoir accÃ©der Ã  ses `properties`

-   rÃ©cupÃ©rer mes cellules pour remplacer leur contenu

-   remplacer le contenu des cellules de ma table avec les `properties`

On va procÃ©der petit Ã  petit. Dâ€™abord, on **vÃ©rifie quâ€™on a bien une feature dans `feature`**Â :

``` javascript
  if (url) {
    fetch(url)
      .then((response) => response.text())
      .then((json) => { // On a aussi changÃ© un truc ici et dans la fonction
        const obj = JSON.parse(json);
        if (obj.features[0]) {
          console.log("Jâ€™ai cliquÃ© sur une featureÂ !");
        } else {
          console.log("Jâ€™ai cliquÃ© Ã  cÃ´tÃ©â€¦");
        }
      });
  }
```

On utilise une condition `if` pour tester la prÃ©sence dâ€™une feature dans `obj`. `obj.features[0]` peut se traduire parÂ : "RÃ©cupÃ¨re mon tableau `feature` de mon `obj` et prends le premier Ã©lÃ©ment". La condition regarde simplement si `feature[0]` est vide ou non. Si ce nâ€™est pas vide, on a reÃ§u quelque chose, on a donc cliquÃ© sur une feature. Au contraire, si câ€™est vide, câ€™est quâ€™on a cliquÃ© Ã  cÃ´tÃ©. Testez la fonction avant de passer Ã  la suite.

Si on a bien rÃ©cupÃ©rÃ© une `feature`, cela veut dire quâ€™on peut rÃ©cupÃ©rer ses `properties`. Il suffit dâ€™ajouter au bon endroit de la fonction les deux lignes suivantesÂ :

``` javascript
const properties = obj.features[0].properties;
console.log(properties);
```

Vous commencez Ã  comprendre comment on accÃ¨de Ã  un Ã©lÃ©ment dans un objet JavaScript. Il suffit dâ€™appeler la propriÃ©tÃ© quâ€™on veut avec `.<propriÃ©tÃ©>`. Regardez comment est structurÃ© votre objet `properties` dans la console du navigateur. Maintenant, modifiez la ligne `console.log(properties);` pour afficher la propriÃ©tÃ© `target_country`. Quand câ€™est rÃ©ussi, passez Ã  la suiteÂ !

TrÃ¨s bien, on sait maintenant rÃ©cupÃ©rer des propriÃ©tÃ©s. Il ne nous reste plus quâ€™Ã  modifier le HTML de notre document en consÃ©quence en utilisant `.innerHTML`Â ! Je vous donne le code pour la colonne `deal_id` et je vous laisse complÃ©ter le code pour les deux autres colonnes.

``` javascript
  if (url) {
    fetch(url)
      .then((response) => response.text())
      .then((json) => {
        const obj = JSON.parse(json);
        if (obj.features[0]) {
          console.log("Jâ€™ai cliquÃ© sur une featureÂ !");
          const properties = obj.features[0].properties;
          console.log(properties);
          // On affiche deal_id dans notre table
          document.getElementById('table-deal-id').innerHTML = properties.deal_id;
        } else {
          console.log("Jâ€™ai cliquÃ© Ã  cÃ´tÃ©â€¦");
          // On a cliquÃ© "nulle part" donc on remet des â€¦ dans la colonne "deal_id"
          document.getElementById('table-deal-id').innerHTML = "";
        }
      });
  }
```

Testez votre application. Normalement, Ã§a marcheÂ ! Quand vous cliquez sur une feature, vous devriez rÃ©cupÃ©rer son ID. VoilÃ  comment on crÃ©e une table customisÃ©e pour interroger une coucheÂ ! **Maintenant, Ã  vous de complÃ©ter les deux autres colonnes.** Une fois que vous avez rÃ©ussi, ajoutez une colonne qui montre la valeur de `mineral_resources` pour le deal sur lequel vous cliquez. Et quand Ã§a aussi Ã§a fonctionne, prenez quelques minutes pour styliser votre tableÂ !

![Si vous vous sentez comme Ã§a aprÃ¨s cet exercice, câ€™est normal. Vous venez de passer un trÃ¨s gros morceau, bien jouÃ© Ã  vousÂ ! Peu importe lâ€™heure, vous avez gagnÃ© le droit dâ€™aller vous chercher le cafÃ© de la victoire pour vous reposer un peu les neurones.](https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExeXA3OHNtMW5vdTlrdHRmbDZwcjUwMWw1bzdjenQ5ZnNwOGI4bzN5cCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/MC4HOOheKrTkMhpL6i/giphy.gif){fig-alt="GIFÂ : Exhausted lady in her bed" fig-align="center"}

## TP â€“ Ajouter une Ã©chelle

Allez, on va faire quelque chose qui demande moins de lignes de code pour sâ€™aÃ©rer un peu la tÃªte. Je vous colle quelques Ã©lÃ©ments pour vous aider ici sans trop vous guider, jâ€™estime que vous devriez pouvoir trouver comment faire assez facilement.

Dâ€™abord, voilÃ  un import OpenLayers fort utileÂ :

``` javascript
import ScaleLine from 'ol/control/ScaleLine.js';
```

Un autre morceau, pour crÃ©er lâ€™objet "Ã©chelle"Â :

``` javascript
const scaleline = new ScaleLine();
```

Et enfin, trouvez comment ajouter Ã§a Ã  votre code existantÂ :

``` javascript
const map = new Map({
  controls: [scaleline],
});
```

Et voilÃ Â !

![Et en prÃ©parant ce TP, jâ€™ai pu dÃ©couvrir que la montÃ©e dâ€™Ã©chelle est un sport qui existe. Ã€ vous dâ€™Ãªtre aussi efficaces avec votre codeÂ !](https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExYTN0MjJ5aDZmY2piMzB6N3dvdGN4OXF6ODM2eXFqdTA2azVqMmtubiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/MnV9h47Yjjujm/giphy.gif){fig-alt="GIFÂ : CompÃ©tition de montÃ©e dâ€™Ã©chelle" fig-align="center"}

## â€¦

La suite est en cours de rÃ©daction. Si vous Ãªtes arrivÃ©â‹…e ici, dÃ©jÃ , vous Ãªtes bien curieuxâ‹…seÂ ! Ensuite, profitez-en pour rÃ©flÃ©chir Ã  ce dont vous auriez besoin dans votre projet GeoNum pour me demander de prÃ©parer de nouveaux exercices.

Si vous avez dÃ©jÃ  des idÃ©es, vous pouvez aussi vous lancerÂ ! Je reste disponible pour aider sur quelque chose qui nâ€™a pas forcÃ©ment Ã©tÃ© prÃ©parÃ© dans mon TP ğŸ˜ƒ